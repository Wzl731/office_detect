# 特征工程分析工具

本工具包用于分析恶意文件检测中的误报问题，通过KS检验和SHAP可视化解释来深入理解特征差异和模型决策过程。

## 📊 数据说明

- **good250623**: 白样本数据 (良性文件特征)
- **bad250623**: 黑样本数据 (恶意文件特征)  
- **good2bad**: 误报数据 (被误判为恶意的良性文件特征)

## 🛠️ 环境配置

### 1. 安装依赖

```bash
# 激活conda环境
conda activate MAGIC

# 安装Python包
pip install -r requirements.txt
```

### 2. 数据准备

确保以下Excel文件存在于 `../data/` 目录中：
- `good250623_features.xlsx`
- `bad250623_features.xlsx`
- `good2bad_features.xlsx`

## 🚀 使用方法

### 方法1: 运行单独分析

#### KS检验分析
```bash
python feature_analysis.py
```
**功能**: 
- 比较白样本和误报样本的特征分布差异
- 识别具有显著统计差异的特征
- 生成KS检验结果和可视化图表

**输出文件**:
- `ks_test_results.xlsx`: 详细的KS检验结果
- `ks_analysis_results.png`: KS分析可视化图表
- `feature_distributions.png`: 重要特征分布对比图

#### SHAP分析
```bash
python shap_analysis.py
```
**功能**:
- 训练随机森林分类模型
- 计算误报样本的SHAP值
- 解释模型对误报样本的预测决策

**输出文件**:
- `random_forest_model.pkl`: 训练好的随机森林模型
- `feature_scaler.pkl`: 特征标准化器
- `shap_feature_importance.xlsx`: SHAP特征重要性排序
- `shap_summary_plot.png`: SHAP摘要图
- `shap_bar_plot.png`: SHAP条形图
- `shap_waterfall_sample_*.png`: 单个样本的SHAP瀑布图

### 方法2: 运行综合分析 (推荐)

```bash
python comprehensive_analysis.py
```
**功能**:
- 自动运行KS检验和SHAP分析
- 比较两种方法的结果
- 生成综合分析报告

**额外输出文件**:
- `ks_shap_comparison.xlsx`: KS检验与SHAP结果比较
- `ks_shap_comparison.png`: 比较结果可视化
- `comprehensive_analysis_report.md`: 综合分析报告

## 📈 分析结果解读

### KS检验结果
- **KS统计量**: 值越大表示两个分布差异越大
- **p值**: < 0.05表示差异具有统计显著性
- **显著特征**: 在白样本和误报样本间存在显著分布差异的特征

### SHAP分析结果
- **SHAP值**: 表示每个特征对模型预测的贡献
- **正值**: 推向恶意类预测
- **负值**: 推向良性类预测
- **绝对值大小**: 表示特征重要性

### 综合分析
- **共同重要特征**: 同时被KS检验和SHAP分析识别为重要的特征
- **排名比较**: 两种方法对特征重要性排序的一致性
- **误报原因**: 基于统计分析和模型解释的误报原因推断

## 🔍 典型分析流程

1. **数据加载**: 自动加载三个数据集
2. **KS检验**: 识别分布差异显著的特征
3. **模型训练**: 训练随机森林分类器
4. **SHAP计算**: 计算误报样本的SHAP值
5. **结果比较**: 比较KS检验和SHAP的发现
6. **报告生成**: 生成综合分析报告和改进建议

## 📋 输出文件说明

| 文件名 | 类型 | 说明 |
|--------|------|------|
| `ks_test_results.xlsx` | 数据 | KS检验详细结果 |
| `shap_feature_importance.xlsx` | 数据 | SHAP特征重要性 |
| `ks_shap_comparison.xlsx` | 数据 | 两种方法结果比较 |
| `comprehensive_analysis_report.md` | 报告 | 综合分析报告 |
| `*.png` | 图表 | 各种可视化图表 |
| `*.pkl` | 模型 | 训练好的模型和预处理器 |

## ⚠️ 注意事项

1. **内存使用**: SHAP计算可能消耗较多内存，建议在内存充足的环境中运行
2. **计算时间**: 完整分析可能需要几分钟到几十分钟，取决于数据大小
3. **Python版本**: 建议使用Python 3.7+
4. **依赖冲突**: 如遇到包版本冲突，请参考requirements.txt调整

## 🛠️ 故障排除

### 常见问题

1. **导入错误**: 确保所有依赖包已正确安装
2. **文件路径错误**: 检查数据文件是否在正确位置
3. **内存不足**: 减少样本数量或使用更大内存的机器
4. **中文显示问题**: 确保系统支持中文字体

### 联系支持

如遇到问题，请检查：
1. 数据文件格式是否正确
2. Python环境是否配置正确
3. 所有依赖包是否安装完整
